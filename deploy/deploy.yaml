---

- name: Deploy bot

  become: yes
  become_user: root
  hosts: vscale_host
  tasks:
    - name: Create db folder
      ansible.builtin.file:
        path: /srv/ToxicBot/db
        state: directory

    - name: Create and start a container
      community.docker.docker_container:
        name: "ToxicBot"
        image: "docker.io/32133789756/toxicbot:{{ DOCKER_TAG }}"
        pull: yes
        state: started
        recreate: yes
        restart_policy: always
        volumes:
          - "/srv/ToxicBot/db:/db"
        env:
          TELEGRAM_TOKEN: "{{ TELEGRAM_TOKEN }}"
          IGOR_ID: "{{ IGOR_ID }}"
          MAX_ID: "{{ MAX_ID }}"
          KIRILL_ID: "{{ KIRILL_ID }}"
          STICKER_SETS: "{{ STICKER_SETS }}"
          GOOGLE_CREDENTIALS: "{{ GOOGLE_CREDENTIALS }}"
          GOOGLE_SPREADSHEET_ID: "{{ GOOGLE_SPREADSHEET_ID }}"
          DEEPSEEK_API_KEY: "{{ DEEPSEEK_API_KEY }}"
          BULLINGS_THRESHOLD_COUNT: "2"
          BULLINGS_THRESHOLD_TIME: "5m"
          DUCKDB_FILE_PATH: "/db/sas.db"

    - name: Prune unused imagages
      community.docker.docker_prune:
        images: yes
        images_filters:
          dangling: yes
